# Logcat Project - Cursor AI Rules

## 项目简介

跨平台 Android Logcat 日志查看工具，Android Studio Logcat 的轻量替代品。

## 技术栈（锁定）

- **框架**: Tauri 2.0 (不要建议 Electron)
- **后端**: Rust
- **前端**: React 18 + TypeScript
- **样式**: Tailwind CSS (不要 CSS-in-JS)
- **状态**: Zustand (不要 Redux)
- **虚拟列表**: @tanstack/react-virtual

## 项目边界

### ✅ 允许
- 日志查看、过滤、导入导出
- 与 Android Studio Logcat 功能对齐
- 显示设置调整

### ❌ 禁止
- 数据库存储
- 网络请求（除 ADB）
- 大型 UI 库（Ant Design 等）

---

## 核心类型（重要）

```typescript
// 日志级别
type LogLevel = "V" | "D" | "I" | "W" | "E" | "A";

// 日志条目 - 这是核心数据结构
interface LogEntry {
  id: number;
  timestamp: string;
  dateTime?: string;
  epoch?: number;
  pid: number;
  tid: number;
  level: LogLevel;
  tag: string;
  message: string;
  packageName?: string;
  processName?: string;
}

// 设备
interface Device {
  id: string;
  name: string;
  model: string;
  state: "device" | "offline" | "unauthorized" | "no device";
  isEmulator: boolean;
}

// 过滤配置
interface FilterConfig {
  levels: LogLevel[];
  tags: string[];
  searchText: string;       // Android Studio 风格查询
  isRegex: boolean;
  isCaseSensitive: boolean;
  packageName?: string;
  pid?: number;
}

// 应用设置
interface AppSettings {
  theme: "light" | "dark" | "system";
  fontSize: number;         // 默认 12
  lineHeight: number;       // 默认 1.5
  maxLogLines: number;      // 默认 100000
  autoScroll: boolean;
  showTimestamp: boolean;
  timestampFormat: "datetime" | "time" | "epoch";
  showPid: boolean;
  showTid: boolean;
  showPackageName: boolean;
  showProcessName: boolean;
  showLevel: boolean;
  showTag: boolean;
  hideRepeatedTags: boolean;
  hideRepeatedPackageName: boolean;
  hideRepeatedProcessName: boolean;
  wrapLines: boolean;
}
```

---

## 文件职责

### 前端核心
| 文件 | 职责 |
|------|------|
| `src/stores/logStore.ts` | 全局状态（Zustand），所有状态操作在这里 |
| `src/lib/utils.ts` | 过滤器解析 `parseLogcatQuery`、导入导出 |
| `src/hooks/useLogStream.ts` | 设备连接、日志流管理、Tauri IPC |
| `src/components/LogList.tsx` | 日志列表（虚拟滚动）|
| `src/components/Toolbar.tsx` | 顶部工具栏（过滤器输入）|
| `src/components/LeftToolbar.tsx` | 左侧操作按钮 |

### 后端核心
| 文件 | 职责 |
|------|------|
| `src-tauri/src/commands.rs` | IPC 命令定义 |
| `src-tauri/src/adb.rs` | ADB 通信、进程缓存 |
| `src-tauri/src/parser.rs` | 日志行解析 |

---

## 代码模式

### 1. 状态管理 (Zustand)

```typescript
// 获取状态
const { logs, filter, settings } = useLogStore();

// 更新状态
const { setFilter, updateSettings, addLogs } = useLogStore();

// 在非组件中获取最新状态
const currentDevices = useLogStore.getState().devices;
```

### 2. Tauri IPC 调用

```typescript
import { invoke } from "@tauri-apps/api/core";
import { listen } from "@tauri-apps/api/event";

// 调用 Rust 命令
const devices = await invoke<Device[]>("get_devices");
await invoke("start_logcat", { deviceId });

// 监听事件
const unlisten = await listen<LogEntry[]>("logcat-entries", (event) => {
  addLogs(event.payload);
});
```

### 3. Rust 命令定义

```rust
#[tauri::command]
pub async fn get_devices() -> Result<Vec<Device>, String> {
    // 实现
}

// 在 main.rs 注册
.invoke_handler(tauri::generate_handler![
    get_devices,
    start_logcat,
    stop_logcat,
])
```

### 4. 虚拟滚动

```typescript
import { useVirtualizer } from "@tanstack/react-virtual";

const virtualizer = useVirtualizer({
  count: filteredLogs.length,
  getScrollElement: () => parentRef.current,
  estimateSize: () => 28,
  overscan: 20,
  measureElement: (el) => el?.getBoundingClientRect().height ?? 28,
});
```

### 5. 过滤器使用

```typescript
import { parseLogcatQuery, matchesQuery } from "../lib/utils";

// 解析查询
const query = parseLogcatQuery("tag:Network -tag:Ads level:WARN");

// 过滤日志
const filtered = logs.filter(log => matchesQuery(log, query));
```

---

## 过滤器语法

```
tag:xxx          # 包含
tag=:xxx         # 精确
tag~:xxx         # 正则
-tag:xxx         # 排除
message:xxx      # 消息
package:xxx      # 包名
level:INFO       # 级别
age:5m           # 时间
is:crash         # 崩溃
tag:a | tag:b    # OR
tag:a tag:b      # AND
```

---

## 性能注意事项

1. **必须使用虚拟滚动** - 日志可能有几十万条
2. **批量添加日志** - 使用 `addLogs` 而非单条 `addLog`
3. **避免重渲染** - 使用 `React.memo`, `useMemo`, `useCallback`
4. **过滤防抖** - 避免每次输入都过滤

---

## 常见任务

### 添加新的设置项
1. `src/types/index.ts` - 在 `AppSettings` 添加字段
2. `src/types/index.ts` - 在 `DEFAULT_SETTINGS` 添加默认值
3. `src/components/SettingsPanel.tsx` - 添加 UI
4. 相关组件中使用 `settings.xxx`

### 添加新的过滤器类型
1. `src/lib/utils.ts` - `FILTER_SUGGESTIONS` 添加提示
2. `src/lib/utils.ts` - `parseLogcatQuery` 添加解析
3. `src/lib/utils.ts` - `matchesQuery` 添加匹配逻辑

### 添加新的 IPC 命令
1. `src-tauri/src/commands.rs` - 定义函数
2. `src-tauri/src/main.rs` - 注册命令
3. 前端 `invoke("command_name", { params })`

---

## 提交规范

```
类型: 简短描述

类型: feat/fix/refactor/style/docs/perf
使用中文
```

---

## 回答规则

1. **使用中文回复**
2. **遵循项目边界**，不建议数据库、网络等禁止功能
3. **参考 Android Studio** Logcat 的实现方式
4. **保持简洁**，避免过度设计
5. **性能优先**，注意大量日志场景
